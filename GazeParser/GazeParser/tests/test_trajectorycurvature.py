import GazeParser
import numpy as np
from GazeParser.TrajectoryCurvature import \
    getAreaCurvature, getInitialDirection, getMaximumDeviation, getRotatedTrajectory

import pathlib
wd = pathlib.Path(__file__).resolve().parent

float_tolerance = 0.0000000001

initial_dir = [
    0.5299469577685645, 0.5088842167799742, 0.49993362578399747, 0.4980968883716551,
    0.5426339429547844, 0.5513982211511013, 0.5660382331624455, 0.6104644247559692,
    0.6292462442371158, 0.7303043698258034, 0.7514324772731031, 0.7833652460064802,
    0.7436963210260727, 0.5401057396354298, 0.5626765548069823, 0.5628597263570505,
    0.34297427787772405, 0.37425717022690286, 0.5578999417623908, 0.5580260464181293,
    0.556083836682819, 0.5524832812366944, 0.48502065048537674, 0.5129049630689062,
    0.5320938264569609, ]

initial_dir_deg = [
    30.363724045936422, 29.156917882312992, 28.644086794095724, 28.53884949229473,
    31.09063475185182, 31.592790902979303, 32.43160180325016, 34.97703508139865,
    36.05315406924494, 41.84335815097976, 43.05390953680896, 44.88352241339879,
    42.61066043420035, 30.945779371901835, 32.23899182140164, 32.249486778147414,
    19.650978603940704, 21.443356306510747, 31.96531205357941, 31.972537318130176,
    31.861256897367678, 31.654960266401897, 27.78963624950191, 29.387289675161682,
    30.486730560950324]

area_curvature = [
    280.9949999999998, -2233.7000000000066, -13.899999999999723, -6116.489999999993,
    137.4050000000001, 56.765000000000306, 2848.619999999997, 109.56999999999903,
    -4671.914999999993, 243.78999999999922, 2204.7350000000015, -25.31500000000038,
    6405.710000000015, 130.82499999999885, -1.774999999999664, -8413.609999999984,
    -336.0449999999991, 2936.6949999999724, 33.68999999999936, 30.130000000000635,
    271.2700000000004, -3581.1849999999986, 176.8199999999995, -55.84499999999962,
    -99.33499999999901]

max_dev = [
    15.717006738429761, -25.18920830680589, -0.745337413095228, -35.114910932219125,
    3.902719506619656, 3.504870672451853, 22.019467111994047, 3.542291410153256,
    -38.436858022897226, 8.122594441677164, 27.81204389951575, -16.763219415530365,
    36.4561800024246, 3.3616529523867547, -0.481387258735343, -55.299999999999955,
    -11.623889616949953, -46.40705619139478, 1.8378756446631188, 1.9736413019072245,
    14.262728528517687, -31.01600910912852, 5.526758520250849, -2.2389777512479485,
    -13.470879123328835]


def test_curvature():
    D, A = GazeParser.load(wd/'data/test01_noconf_usefp_ref.db')
    for i in range(D[0].nSac):
        traj = D[0].Sac[i].getTraj()
        rtraj = getRotatedTrajectory(traj)

        assert np.abs(initial_dir[i]-getInitialDirection(traj, 3)) < float_tolerance
        assert np.abs(initial_dir_deg[i]-getInitialDirection(traj, 3, unit='deg')) < float_tolerance

        assert np.abs(area_curvature[i]-getAreaCurvature(rtraj)) < float_tolerance

        #assert (rtraj == getRotatedTrajectory(traj)).all()
        assert np.abs(max_dev[i]-getMaximumDeviation(rtraj)) < float_tolerance


